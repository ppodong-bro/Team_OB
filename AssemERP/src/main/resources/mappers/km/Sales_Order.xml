<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.WiseForce.AssemERP.Sales_OrderMapper">
	<select id="salesTotCnt" resultType="int">
		SELECT COUNT(*) FROM
		SALES_ORDER
	</select>

	<resultMap type="Sales_OrderDto" id="sales_OrderMap">
		<id column="SALES_NO" property="sales_No" />
		<result column="SALES_DATE" property="sales_Date" />
		<result column="OUT_STATUS" property="out_Status" />
		<result column="DEL_STATUS" property="del_Status" />
		<result column="IN_DATE" property="in_Date" />

		<association property="clientDto" javaType="ClientDto">
			<id column="CLIENT_NO" property="client_No" />
			<result column="CLIENT_NAME" property="client_Name" />
			<result column="CLIENT_GUBUN" property="client_Gubun" />
			<result column="CLIENT_EMAIL" property="client_Email" />
			<result column="CLIENT_MAN" property="client_Man" />
			<result column="CLIENT_ADDRESS" property="client_Address" />
			<result column="DEL_STATUS" property="del_Status" />
			<result column="MODIFY_DATE" property="modify_Date" />
			<result column="IN_DATE" property="in_Date" />
		</association>

		<association property="empDTO" javaType="EmpDTO">
			<id column="EMP_NO" property="empNo" />
			<result column="EMP_NAME" property="empName" />
			<result column="EMP_TEL" property="empTel" />
			<result column="EMAIL" property="email" />
			<result column="SAL" property="sal" />
			<result column="DEPT_CODE" property="deptCode" />
			<result column="USERNAME" property="username" />
			<result column="PASSWORD" property="password" />
			<result column="ROLES_STATUS" property="rolesStatus" />
			<result column="DEL_STATUS" property="delStatus" />
			<result column="REGISTRAR" property="registrar" />
			<result column="IN_DATE" property="inDate" />
		</association>

		<collection property="sales_Item" ofType="Sales_ItemDto">
			<id column="SALES_NO" property="sales_No" />
			<id column="PRODUCT_NO" property="product_No" />
			<result column="SALES_ITEM_CNT" property="sales_Item_Cnt" />
			<result column="SALES_ITEM_OUTCNT"
				property="sales_Item_OutCnt" />
			<result column="SALES_ITEM_COST" property="sales_Item_Cost" />

			<association property="productDto" javaType="ProductDTO">
				<id column="PRODUCT_NO" property="product_no" />
				<result column="PRODUCT_NAME" property="product_name" />
			</association>
		</collection>

	</resultMap>
	
	<resultMap type="Sales_OrderDto" id="createListMap"></resultMap>

	<select id="totSales" parameterType="Sales_OrderSearchDto"
		resultType="int">
		SELECT COUNT(*)
		FROM (SELECT SALES_NO
		FROM SALES_ORDER S
		LEFT JOIN EMP E ON S.EMP_NO = E.EMP_NO
		LEFT JOIN CLIENT C ON S.CLIENT_NO = C.CLIENT_NO
		<where>
			S.DEL_STATUS = 0
			<!-- <if test="sales_No != null and sales_No.trim() != ''"> AND TO_CHAR(S.SALES_NO) 
				LIKE '%' || #{sales_No} || '%' </if> -->
			<if test="client_Name != null and client_Name.trim() != ''">
				AND C.CLIENT_NAME LIKE '%' || #{client_Name} || '%'
			</if>
			<if test="empName != null and empName.trim() != ''">
				AND E.EMP_NAME LIKE '%' || #{empName} || '%'
			</if>
			<if test="out_Status != null">
				AND S.OUT_STATUS = #{out_Status}
			</if>
			<if test="sales_Date_Start != null">
				AND S.SALES_DATE <![CDATA[>=]]> #{sales_Date_Start}
			</if>
			<if test="sales_Date_End != null">
				AND S.SALES_DATE<![CDATA[<=]]> #{sales_Date_End}
			</if>

		</where>
		)
	</select>

	<select id="listSales" parameterType="Sales_OrderSearchDto"
		resultMap="sales_OrderMap">
  	<![CDATA[
    	SELECT S.SALES_NO, S.SALES_DATE, S.OUT_STATUS, S.DEL_STATUS
         	 , S.IN_DATE, H.CLIENT_NO, H.CLIENT_NAME
         	 , E.EMP_NO, E.EMP_NAME
         	 , I.PRODUCT_NO, I.SALES_ITEM_CNT, I.SALES_ITEM_OUTCNT
         	 , I.SALES_ITEM_COST, P.PRODUCT_NO, P.PRODUCT_NAME
    	FROM (	SELECT ROWNUM RN , O.*
			    FROM (SELECT *
			    	  FROM   SALES_ORDER
			      	  WHERE  DEL_STATUS = 0
			      	  ORDER BY SALES_NO DESC
			    	  ) O
		      )S
    	LEFT JOIN CLIENT  C ON S.CLIENT_NO = C.CLIENT_NO
    	LEFT JOIN CLIENT_HIS H ON S.CLIENT_NO = H.CLIENT_NO AND S.IN_DATE BETWEEN H.START_DATE AND END_DATE
    	LEFT JOIN EMP     E ON S.EMP_NO    = E.EMP_NO
    	LEFT JOIN SALES_ITEM I ON S.SALES_NO = I.SALES_NO
    	LEFT JOIN PRODUCT P ON I.PRODUCT_NO = P.PRODUCT_NO
  ]]>

		<where>

			<if test="client_Name != null and client_Name.trim() != ''">
				AND C.CLIENT_NAME LIKE '%' || #{client_Name} || '%'
			</if>
			<if test="empName != null and empName.trim() != ''">
				AND E.EMP_NAME LIKE '%' || #{empName} || '%'
			</if>
			<if test="out_Status != null">
				AND S.OUT_STATUS = #{out_Status}
			</if>
			<if test="start != null and end != null">
				AND RN <![CDATA[>=]]>
				#{start} AND RN <![CDATA[<=]]>
				#{end}
			</if>
			<if test="sales_Date_Start != null">
				AND S.SALES_DATE <![CDATA[>=]]> #{sales_Date_Start}
			</if>
			<if test="sales_Date_End != null">
				AND S.SALES_DATE<![CDATA[<=]]> #{sales_Date_End}
			</if>
		</where>
		ORDER BY S.SALES_NO DESC
	</select>
	
	<select id="detailSales" parameterType="int" resultMap="sales_OrderMap">
		SELECT S.SALES_NO, S.SALES_DATE, S.OUT_STATUS, S.DEL_STATUS
         	 , S.IN_DATE, H.CLIENT_NO, H.CLIENT_NAME, H.CLIENT_EMAIL
         	 , H.CLIENT_MAN, H.CLIENT_ADDRESS
         	 , E.EMP_NO, E.EMP_NAME
         	 , I.PRODUCT_NO, I.SALES_ITEM_CNT, I.SALES_ITEM_OUTCNT
         	 , I.SALES_ITEM_COST, P.PRODUCT_NO, P.PRODUCT_NAME
        FROM SALES_ORDER S LEFT JOIN CLIENT C ON S.CLIENT_NO = C.CLIENT_NO
        				   LEFT JOIN CLIENT_HIS H ON S.CLIENT_NO = H.CLIENT_NO AND S.IN_DATE BETWEEN H.START_DATE AND H.END_DATE
        	    		   LEFT JOIN EMP    E ON S.EMP_NO    = E.EMP_NO
        	    		   LEFT JOIN SALES_ITEM I ON S.SALES_NO = I.SALES_NO
        	    		   LEFT JOIN PRODUCT P ON I.PRODUCT_NO = P.PRODUCT_NO
        WHERE S.SALES_NO = #{sales_No}
	</select>
	
	<select id="salesProductList" resultType="productDTO">
		SELECT PRODUCT_NO, PRODUCT_NAME
		FROM PRODUCT
	</select>
	
	<select id="salesClientList" resultType="clientDto">
		SELECT *
		FROM CLIENT
	</select>
	


</mapper>