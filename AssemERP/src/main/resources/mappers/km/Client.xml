<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.WiseForce.AssemERP.ClientMapper">
	<select id="clientTotCnt" resultType="int">
		SELECT COUNT(*) FROM Client
	</select>
	
	<resultMap type="ClientDto" id="clientMap">
		<id 	column="CLIENT_NO"   	property="client_No"/>
		<result	column="CLIENT_NAME" 	property="client_Name"/>
		<result	column="CLIENT_GUBUN" 	property="client_Gubun"/>
		<result column="CLIENT_EMAIL"	property="client_Email"/>
		<result column="CLIENT_MAN"		property="client_Man"/>
		<result column="CLIENT_TEL"     property="client_Tel"/>
		<result	column="CLIENT_ADDRESS"	property="client_Address"/>
		<result	column="DEL_STATUS"		property="del_Status"/>
		<result column="MODIFY_DATE"	property="modify_Date"/>
		<result column="IN_DATE"		property="in_Date"/>
		
		<association property="empDTO" javaType="EmpDTO" >
			<id 	column="EMP_NO"			property="empNo"/>
			<result column="EMP_NAME"  		property="empName"/>
			<result	column="EMP_TEL"		property="empTel"/>
			<result	column="EMAIL"			property="email"/>
			<result	column="SAL"			property="sal"/>
			<result	column="DEPT_CODE"		property="deptCode"/>
			<result	column="USERNAME"		property="username"/>
			<result column="PASSWORD"		property="password"/>
			<result	column="ROLES_STATUS"	property="rolesStatus"/>
			<result column="DEL_STATUS"		property="delStatus"/>
			<result	column="REGISTRAR"		property="registrar"/>
			<result	column="IN_DATE"		property="inDate"/>
		</association>
	</resultMap>
	
	
	 <select id="totClient" parameterType="ClientSearchDto" resultType="int">
	 
    SELECT COUNT(*) 
      FROM Client
	    <where>
	        DEL_STATUS = 0
	      <if test="client_Name != null and client_Name.trim() != ''">
	        AND client_name LIKE '%' || #{client_Name} || '%'
	      </if>
	      <if test="client_Gubun != null">
	        AND client_gubun = #{client_Gubun}
	      </if>
	      <if test="client_Man != null and client_Man.trim() != ''">
	        AND client_man LIKE '%' || #{client_Man} || '%'
	      </if>
	      <!-- 필요하다면 inDateStart/End 조건도 추가 -->
	    </where>
  	</select>
  
	<select id="clientList" parameterType="ClientSearchDto" resultType="ClientDto">
    <![CDATA[
    SELECT A.*
      FROM (
        SELECT ROWNUM RN, B.*
          FROM (
            	SELECT *
                FROM Client
 	]]>
			    <where>
			        DEL_STATUS = 0
			      <if test="client_Name != null and client_Name.trim() != ''">
			        AND client_Name LIKE '%' || #{client_Name} || '%'
			      </if>
			      <if test="client_Gubun != null">
			        AND client_Gubun = #{client_Gubun}
			      </if>
			      <if test="client_Man != null and client_Man.trim() != ''">
			        AND client_Man LIKE '%' || #{client_Man} || '%'
			      </if>
			    </where>
			      ORDER BY client_No DESC
    	)B
    ) A
    WHERE A.RN <![CDATA[>=]]>#{start} AND A.RN <![CDATA[<=]]> #{end}
    ORDER BY RN
	</select>
	
	<select id="detailClient" parameterType="int" resultMap="clientMap">
		SELECT C.CLIENT_NO, E.EMP_NO, E.EMP_NAME, C.CLIENT_NAME, C.CLIENT_GUBUN
			 , C.CLIENT_EMAIL, C.CLIENT_MAN, C.CLIENT_ADDRESS
			 , C.DEL_STATUS, C.MODIFY_DATE, C.IN_DATE, C.CLIENT_TEL
		FROM   CLIENT C LEFT JOIN EMP E ON C.EMP_NO = E.EMP_NO
		WHERE  C.CLIENT_NO = #{client_No}
	</select>
	
	<insert id="createClient" parameterType="ClientDto">
		INSERT INTO Client 
		(CLIENT_NO, EMP_NO, CLIENT_NAME
	   , CLIENT_GUBUN, CLIENT_EMAIL, CLIENT_MAN, CLIENT_TEL
	   , CLIENT_ADDRESS,DEL_STATUS ,IN_DATE)
		 VALUES
	    (CLIENT_SEQ_GEN.NEXTVAL, #{empDTO.empNo}, #{client_Name}, #{client_Gubun}, #{client_Email}, #{client_Man}, #{client_Tel}, #{client_Address}, 0, SYSDATE)
	</insert>
	
	<update id="modifyClient" parameterType="ClientDto">
		UPDATE client 
		SET emp_no = #{empDTO.empNo}, client_name = #{client_Name}, client_gubun = #{client_Gubun}
          , client_email = #{client_Email}, client_man = #{client_Man}, client_tel= #{client_Tel}
          , client_address = #{client_Address}, modify_date = SYSDATE
        WHERE client_no = #{client_No}
	</update>
	
	<update id="deleteClient" parameterType="ClientDto">
		UPDATE client
		SET del_status = 1
		WHERE client_no = #{client_No}
	</update>
	
	<update id="client_HisEnd" parameterType="Client_HisDto">
		UPDATE client_His
		SET end_date = #{end_Date}
		WHERE client_no = #{client_No} AND end_Date = '99991231'
	</update>
	
	<insert id="client_His" parameterType="Client_HisDto">
		INSERT INTO CLIENT_HIS (CLIENT_NO, START_DATE, END_DATE, EMP_NO, CLIENT_NAME
							  , CLIENT_GUBUN, CLIENT_MAN, CLIENT_EMAIL, CLIENT_TEL
							  , CLIENT_ADDRESS, IN_DATE)
		VALUES (#{client_No}, #{start_Date}, #{end_Date}, #{emp_No}
			  , #{client_Name}, #{client_Gubun}, #{client_Man}
			  , #{client_Email}, #{client_Tel}, #{client_Address}, SYSDATE)
	</insert>
</mapper>